# 无分叉升级

substrate 无分叉升级 原理是什么?



Substrate 是一个模块化的区块链开发框架，提供了无分叉升级（forkless upgrade）的能力，这是其相较于传统区块链技术的一个重要优势。无分叉升级的原理基于 Substrate 的 runtime 设计和链上治理机制。下面我将从技术原理、实现机制以及工作流程三个方面来介绍 Substrate 无分叉升级的原理。

### 1. 技术原理

Substrate 的无分叉升级主要是通过将区块链的 **Runtime（运行时）** 作为区块链的可升级部分来实现的。在 Substrate 中，Runtime 其实是一个被嵌入在区块链节点内的 WebAssembly（Wasm）程序。所有的链上逻辑（如交易验证、区块生成、共识机制、治理逻辑等）都被包含在 Runtime 中。

- **WebAssembly（Wasm）**：Substrate 将 Runtime 编译为 Wasm 文件，并将其存储在链上（链上存储），而不是像传统区块链那样把升级逻辑写死在节点程序中。这样，新的链上状态可以通过更新链上存储的 Wasm 文件来实现，而不需要通过硬分叉去改变每个节点的底层代码。
- **链上治理（On-chain Governance）**：通过链上治理机制，可以在链上提议并通过投票的方式决定是否进行 Runtime 升级。当提案通过时，节点就会自动从链上存储中获取新的 Wasm Runtime 文件，并开始使用新的代码执行区块链逻辑。

### 2. 实现机制

Substrate 的无分叉升级主要依赖以下几个核心机制：

1. **链上存储 Wasm Runtime**：
    - 在 Substrate 链中，Runtime 会以一个字节码文件（Wasm 形式）被存储在链上，这样所有节点都可以通过调用链上存储的数据来使用当前的 Runtime 逻辑。
    - 每个区块会调用当前版本的 Runtime 进行执行。当新的 Runtime 被写入链上存储时，所有节点都会在执行区块时自动使用新的 Runtime。
2. **Runtime 升级提案**：
    - Runtime 升级是通过链上的治理机制来发起的。治理模块（如 Democracy 模块）允许用户或管理员发起提案，经过投票（例如全民投票、技术委员会表决等）决定是否升级 Runtime。
    - 当提案通过后，新的 Runtime（即 Wasm 字节码文件）会被写入链上存储，触发 Runtime 的自动升级。
3. **热插拔（Hot-swapping）机制**：
    - 当链上存储的 Runtime 发生变化时，所有节点会自动检测到变化，并在下一个区块开始使用新的 Runtime 执行逻辑。这就是所谓的“热插拔”机制，允许链的逻辑在不停止、不分叉的情况下平滑升级。
    - 在升级过程中，节点会自动检查新 Runtime 的兼容性（例如结构变更、类型变更），并在必要时回退到之前的版本。

### 3. 工作流程

Substrate 的无分叉升级大致包括以下步骤：

1. **Runtime 升级提案**：
    1. 通过链上治理机制（如民主投票或技术委员会）提交新的 Runtime 升级提案。
    2. 用户、开发者或管理员将新的 Wasm 代码（新版本的 Runtime）作为提案内容附加到治理提案中。
2. **提案审议和表决**：
    1. 提案经过一定的审议期（根据治理规则），进入表决阶段。
    2. 参与者（如所有代币持有者或指定的治理角色）投票决定是否接受升级提案。
3. **提案通过及写入链上存储**：
    1. 如果提案通过，则新的 Wasm 字节码文件会被写入链上存储，替换掉旧的 Runtime。
    2. 所有节点会自动检测到这一变化，并开始在下一个区块中使用新的 Runtime。
4. **无分叉升级生效**：
    1. 由于 Runtime 是通过链上存储控制的，所有节点都会在同步区块时自动加载新 Runtime，而无需手动升级节点程序或重启节点。
    2. 节点会使用新的 Runtime 执行链上逻辑，从而完成无分叉升级。

### 4. 优势

Substrate 的无分叉升级机制相比传统区块链的硬分叉有许多优势：

- **避免硬分叉**：避免了因节点不同步或用户分歧导致的链分叉现象。
- **平滑升级**：升级是由链上治理机制发起和控制的，在不影响区块链正常运行的情况下实现。
- **治理灵活性**：通过链上治理机制，可以更加灵活地管理和控制区块链的升级流程。
- **开发者体验好**：开发者可以轻松地更新链上逻辑，而不需要强制用户更新客户端软件。

### 5. 实例

以 Polkadot 为例，Polkadot 的 Runtime 就是通过这种方式来进行升级的。每次 Runtime 升级都会先通过链上提案和表决，然后将新的 Runtime Wasm 写入链上。之后，所有节点都会自动使用新的 Runtime 执行逻辑，而不会因为节点版本差异而导致链分叉。

### 6. 总结

Substrate 的无分叉升级是通过将区块链核心逻辑（Runtime）与节点分离，并使用链上治理机制来管理 Runtime 的变更实现的。这使得 Substrate 链能够在不分叉的情况下平滑地进行逻辑升级，从而提高了区块链的稳定性和灵活性。
